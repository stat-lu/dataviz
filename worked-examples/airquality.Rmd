---
title: "Worked Example: Air Quality"
author: 
- "Johan Larsson"
- "Behnaz Pirzamanbein"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    highlight: pygments
    global_numbering: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.width = 5,
  fig.height = 4,
  dev = "png"
)
options(scipen = 999)
```

# Air Quality in New York

As soon as you encounter two numeric variables, your first instinct should
always be visualizing them on a scatter plot. For example, the `airquality` dataset, which includes air quality measurements from New York between May and September 1973, presents such an opportunity.

The variables in this data set are

- `Ozone`: Mean ozone in parts per billion from 1300 to 1500 hours at Roosevelt Island

- `Solar.R`: Solar radiation in Langleys in the frequency band 4000–7700 Angstroms from 0800 to 1200 hours at Central Park

- `Wind`: Average wind speed in miles per hour at 0700 and 1000 hours at LaGuardia
  Airport

- `Temp`: Maximum daily temperature in degrees Fahrenheit at La Guardia Airport.

- `Day`, `Month`: Self-explanatory.

Here are the first few rows of the data set.

```{r}
head(airquality)
```

Let's begin by studying how wind affects air pollution, specifically the level of ozone, in the air. Take a minute to consider how you would map the variables to the
axes to study this relationship.

Well, our layman intuition tells us that it's likely that the wind affects air
pollution, and not the other way around, so the natural mapping here is
to place wind speed on the x axis and ozone on the y axis.

```{r, fig.cap = "Ozone and solar radiation from September to May in New York."}
library(tidyverse)

airquality %>%
  ggplot(aes(Wind, Ozone)) +
  geom_point() +
  labs(x = "Wind Speed (mph)", y = "Ozone (ppb)")
```

There is clearly a strong negative relationship between wind speed and
ozone --- as wind speed increases, air quality seems to improve. That's
hardly surprising if you think about it. But what kind of relationship is this?
Describing it as a linear relationship is not accurate.

The best way to describe this relationship is as an *inverse* relationship. That
is, ozone is inversely proportional to wind speed, which is equivalent to
saying that the relationship could be described as
$$
\text{ozone} = \frac{c}{\text{wind speed}}
$$
for some choice of a constant $c$.

Take some time to plot the associations between `Ozone`, `Solar.R`, `Wind`,
and `Temp` and try to identify any patterns you observe.

## Longitudinal Data

These data are longitudinal in nature, so examining how these measures vary over time is a reasonable approach. First, however, we need to
combine the day and month variables into a single variable representing time.
To do this, we can use the handy `make_date()` function from the **lubridate** package.

```{r}
library(lubridate)

airquality_formatted <-
  airquality %>%
  as_tibble() %>% # tibbles are nicer to work with than data frames, do you know why?
  mutate(Date = make_date("1973", Month, Day))

airquality_formatted
```

Now we're ready to explore the data. The primary focus of this data set is
air quality, so our main interest is in examining ozone levels over time.

Here is our first attempt: we will use the line geom, which is a natural choice
for visualizing this type of data.

```{r, fig.cap = "Air quality (ozone levels) in 1973", fig.width = 5.5, fig.height = 1.8}
p1 <-
  airquality_formatted %>%
  ggplot(aes(Date, Ozone)) +
  geom_line() +
  labs(y = "Ozone (ppb)")

p1
```

The result is possibly not quite as nice as you'd expect. Can you figure out
why there are multiple holes in the plot?

The reason is that there are missing values in the data set. Normally, missing values wouldn't necessarily pose a problem for visualization. However, in this case, observations adjacent to missing ones also disappear from the visualization when using the line geom.

A possible solution here is to drop the missing values, which allows the points to connect.

```{r, fig.cap = "Air quality (ozone levels) in 1973", fig.width = 5.5, fig.height = 1.8}
airquality_nona <- drop_na(airquality_formatted, Ozone)

p2 <-
  airquality_nona %>%
  ggplot(aes(Date, Ozone)) +
  geom_line() + 
  labs(y = "Ozone (ppb)")

p2
```

One potential problem with this approach is that it's hard to tell which date ranges  correspond to missing values. To address this, adding a point geom can help make these ranges clear.

```{r, fig.cap = "Air quality (ozone levels) in 1973.", fig.width = 5.5, fig.height = 1.8}
p3 <- p2 + geom_point()
p3
```

It seems quite clear that the air quality takes a turn for the worse during the
summer months.

### Air Pollution across the Week

One aspect currently missing from the visualization, which could provide further insight, is the relationship between air pollution and the type of day — specifically, distinguishing between weekdays and weekends. A possible
solution for this might be to color the weekend days differently. However, in this case, we'll use the grid and axis ticks to display this information. We can achieve this by specifying scales with `scale_x_date()` and inputting `"weeks"` into the
`minor_breaks` argument.

```{r, fig.cap = "Air quality, in terms of ozone levels, in 1973", fig.width = 5.5, fig.height = 1.8}
p4 <- p3 + scale_x_date(minor_breaks = "weeks")
p4
```

Unfortunately, it is hard to see a clear pattern here, likely because
air pollution varies significantly from day to day due to other factors. 
A possible way to solve this is to create a new variable, `Weekday`, in our
data set, representing the day of the week. For this purpose, we use the `wday()` function from lubridate.

```{r, fig.cap = "Air pollution across the week from May to June in 1973"}
airquality_1973 <-
  airquality_nona %>%
  mutate(Weekday = wday(Date))

airquality_1973 %>%
  ggplot(aes(Weekday, Ozone)) +
  geom_point() + 
  labs(y = "Ozone (ppb)")
```

Great, but now the point geom is probably not the best candidate for this job,
specially without adjustments like jittering and/or opacity. A better alternative could be to use box plots. To effectively use box plots, we need to convert the
`Weekday` variable into a factor variable. Ensuring the correct order of days, we'll use `as.ordered()`. This conversion can be done directly in the `ggplot()` call. However, it's important to note that this approach requires manually adjusting the axis label, as it will default to `"as.ordered(Weekday)"` otherwise.

```{r, fig.cap = "Air pollution across weekdays from May to June in 1973", fig.width = 5.5}
airquality_1973 %>%
  ggplot(aes(as.ordered(Weekday), Ozone)) +
  geom_boxplot() +
  labs(x = "Weekday", y = "Ozone (ppb)")
```

Now, we *can* actually see a slight improvement in air quality over
the weekends, at least in terms of the median values. At this point, it would be 
interesting to extend our investigation by examining the outliers in this
plot to see if they correspond to specific calendar events.

Additionally, take some time to visualize the relationships between time and the other
variables in the data set.

# Source Code

The source code for this document is available at
<https://github.com/stat-lu/dataviz/blob/main/worked-examples/airquality.Rmd>.
